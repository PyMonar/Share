<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>Vue的服务器端渲染-彭一</title>

    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/theme/white.css">

    <!-- Theme used for syntax highlighting of code -->
    <link rel="stylesheet" href="lib/css/zenburn.css">

    <style>
        .vue {
            color: #42b983;
        }
        .warning {
            color: #f66;
        }
        .unimportant {
            color: #bcbcbc;
        }
        #menu li{
            word-break: keep-all;
            line-height: 1.5em;
        }
    </style>
</head>

<body>
    <div class="reveal">
        <div class="slides">
            <section>
                <section>
                    <h2>
                        <span class="vue">Vue</span>的服务器端渲染
                    </h2>
                    <p><span class="unimportant">彭一</span></p>
                </section>
            </section>
            <section>
                <h2><span class="unimportant">目录</span></h2>
                <ol id="menu">
                    <li>
                        什么是服务器端渲染
                    </li>
                    <li>
                        为什么要服务器端渲染
                    </li>
                    <li>
                        Vue服务器端渲染原理
                    </li>
                    <li>
                        实现服务器端渲染
                    </li>
                    <li>
                        服务器端渲染VS客户端渲染
                    </li>
                </ol>
            </section>
            <section>
                <section>
                    <h2>
                        1. 什么是服务器端渲染
                    </h2>
                    <p class="unimportant">Server Side Render</p>
                </section>
                <section>
                    <h3><span class="vue">背景</span></h3>
                    <hr>
                    <span>Web研发模式的演变</span>
                </section>
                <section>
                    <h6>
                        1. <span class="vue">Web 1.0</span>
                    </h6>
                    <hr>
                    <div>
                        <img width="541" height="382" alt="web 1.0" src="./img/1.jpeg" data-lazy-loaded="">
                    </div>
                </section>
                <section>
                    <h6>
                        2. <span class="vue">Struts MVC</span>
                    </h6>
                    <hr>
                    <div>
                        <img width="541" height="382" alt="MVC" src="./img/2.jpeg" data-lazy-loaded="">
                    </div>
                </section>
                <section>
                    <h6>
                        3. <span class="vue">Web 2.0</span>
                    </h6>
                    <hr>
                    <div>
                        <img width="541" height="382" alt="web 2.0" src="./img/3.jpeg" data-lazy-loaded="">
                    </div>
                </section>
                <section>
                    <h6>
                        4. <span class="vue">Single Page Application</span>
                    </h6>
                    <hr>
                    <div>
                        <img width="541" height="382" alt="SPA" src="./img/4.jpeg" data-lazy-loaded="">
                    </div>
                </section>
                <section>
                    <h6>
                        5. <span class="vue">Full Stack</span>
                    </h6>
                    <hr>
                    <div>
                        <img width="590" height="540" alt="Full Stack" src="./img/5.png" data-lazy-loaded="">
                    </div>
                </section>
                <section>
                    <h6>
                        <span class="vue">结论</span>
                    </h6>
                    <hr>
                    <p>
                        服务器端生成静态HTML返回客户端，然后与客户端混合成为可交互的应用程序
                    </p>
                </section>
            </section>
            <section>
                <section>
                    <h2>
                        2. 为什么要服务器端渲染
                    </h2>
                    <p class="unimportant">Why SSR</p>
                </section>
                <section>
                    <h4>前端两个<span class="warning">痛点</span></h4>
                    <hr>
                    <ul>
                        <li>SEO(Search Engine Optimization)</li>
                        <li>首屏渲染性能</li>
                    </ul>
                </section>
                <section data-markdown>
                    #### 你是否真的需要SSR
                    ---
                    - 服务器端的开发条件限制
                    - 需要Node的运行环境
                    - 增加服务器端负载
                </section>
            </section>
            <section>
                <section>
                    <h2>
                        3. Vue服务器端渲染原理
                    </h2>
                    <p class="unimportant">Vue SSR Principle</p>
                </section>
                <section>
                    <h6>
                        <span class="vue">技术栈</span>
                    </h6>
                    <hr>
                    <ul>
                        <li>Vue + Vue-router + Vuex</li>
                        <li>Webpack</li>
                        <li>Express/Koa</li>
                    </ul>
                </section>
                <section>
                    <h6>
                        <span class="vue">构建步骤</span>
                    </h6>
                    <hr>
                    <div>
                        <img width="1078" height="453" alt="Vue-SSR" src="./img/vue-ssr.png" data-lazy-loaded="">
                    </div>
                </section>
            </section>
            <section>
                <section>
                    <h2>
                        4. 实现服务器端渲染
                    </h2>
                    <p class="unimportant">Vue SSR Implement</p>
                </section>
                <section data-markdown>
                    #### 代码结构
                    ---
                    ```
                    build
                    ├── webpack.base.config.js
                    ├── webpack.client.config.js
                    ├── webpack.server.config.js
                    src
                    ├── components
                    │   ├── Movie.vue
                    │   └── US.vue
                    ├── router
                    │   └── index.js
                    ├── store
                    │   └── index.js
                    ├── App.vue
                    ├── app.js # 通用 entry
                    ├── entry-client.js # 仅运行于浏览器
                    ├── entry-server.js # 仅运行于服务器
                    index.template.html
                    server.js
                    ```
                </section>
                <section>
                    <h6>
                        <span class="vue">渲染核心</span>
                    </h6>
                    <hr>
                    <ul>
                        <li><span class="vue">vue-server-renderer</span></li>
                        <li>依赖于Node原生模块</li>
                        <li>作用：将vue实例渲染为HTML片段</li>
                        <li>
                            <span class="vue">createRenderer()</span>
                        </li>
                        <li>
                            <span class="vue">createBundleRenderer()</span>
                        </li>
                    </ul>
                </section>
                <section data-markdown>
                    <script type="text/template">
                    ```javascript
                    // 第 1 步：创建一个 Vue 实例
                    const Vue = require('vue')
                    const app = new Vue({
                        template: `<div>Hello World</div>`
                    })
                    
                    // 第 2 步：创建一个 renderer
                    const renderer = require('vue-server-renderer').createRenderer()
                    
                    // 第 3 步：将 Vue 实例渲染为 HTML
                    renderer.renderToString(app, (err, html) => {
                        if (err) throw err
                        console.log(html)
                        // => <div data-server-rendered="true">Hello World</div>
                    })
                    
                    // 在 2.5.0+，如果没有传入回调函数，则会返回 Promise：
                    renderer.renderToString(app).then(html => {
                        console.log(html)
                    }).catch(err => {
                        console.error(err)
                    })
                    ```
                    </script>
                </section>
                <section data-markdown>
                    <script type="text/template">
                    #### 集成服务器
                    ---
                    ```javascript
                    // server.js
                    const Vue = require('vue')
                    const server = require('express')()
                    const renderer = require('vue-server-renderer').createRenderer()
                    server.get('*', (req, res) => {
                        const app = new Vue({
                            template: `<div>From Server</div>`
                        })
                        renderer.renderToString(app, (err, html) => {
                        if (err) {
                            res.status(500).end('Internal Server Error')
                            return
                        }
                        res.end(html)
                    })
                    server.listen(8080)
                    ```
                    </script>
                </section>
                <section data-markdown>
                    #### 注入模板
                    ---
                    ```javascript
                    const renderer = createRenderer({
                        template: require('fs').
                                  readFileSync('./index.template.html', 'utf-8')
                    })
                    
                    renderer.renderToString(app, (err, html) => {
                        console.log(html) // html 将是注入应用程序内容的完整页面
                    })
                    ```
                </section>
                <section>
                    <h6>
                        <span class="vue">约束条件</span>
                    </h6>
                    <hr>
                    <ul>
                        <li>
                            针对每个请求每个vue实例都应该是全新的，避免状态污染
                        </li>
                        <li>
                            vue组件的生命周期钩子只有<code class="vue">beforeCreate</code>和<code class="vue">created</code>在SSR过程中被调用
                        </li>
                        <li>
                            浏览器端独有的变量或者api无效，比如window、document
                        </li>
                    </ul>
                </section>
                <section data-transition="concave" data-background="#4d7e65" data-background-transition="zoom">
                    App
                </section>
                <section data-transition="concave" data-background="#b5533c" data-background-transition="zoom">
                    Router
                </section>
                <section data-transition="concave" data-background="#2e65ad" data-background-transition="zoom">
                    Entry
                </section>
                <section>
                    数据预取
                </section>
                <section>
                    客户端激活
                </section>
                <section>
                    Bundle Renderer
                </section>
                <section>
                    Webpack 配置
                </section>
            </section>
            <section>
                <section>
                    <h3>
                        5. 服务器端渲染 VS 浏览器端渲染
                    </h3>
                </section>
                <section>
                    后续 Nuxt.js
                </section>
            </section>
            <section>
                <section>
                    <h2>
                        谢谢
                    </h2>
                </section>
            </section>
        </div>
    </div>

    <script src="lib/js/head.min.js"></script>
    <script src="js/reveal.js"></script>

    <script>
        Reveal.initialize({
            controls: true,
            progress: true,
            history: true,
            center: true,

            transition: 'convex', // none/fade/slide/convex/concave/zoom
            dependencies: [{
                src: 'lib/js/classList.js',
                condition: function() {
                    return !document.body.classList;
                }
            }, {
                src: 'plugin/markdown/marked.js',
                condition: function() {
                    return !!document.querySelector('[data-markdown]');
                }
            }, {
                src: 'plugin/markdown/markdown.js',
                condition: function() {
                    return !!document.querySelector('[data-markdown]');
                }
            }, {
                src: 'plugin/highlight/highlight.js',
                async: true,
                callback: function() {
                    hljs.initHighlightingOnLoad();
                }
            }, {
                src: 'plugin/zoom-js/zoom.js',
                async: true
            }, {
                src: 'plugin/notes/notes.js',
                async: true
            }]
        });
    </script>
</body>

</html>